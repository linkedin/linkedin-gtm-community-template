___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "LinkedIn InsightTag 2.0",
  "categories": [
    "ADVERTISING",
    "MARKETING",
    "ANALYTICS"
  ],
  "brand": {
    "id": "github.com_linkedin",
    "displayName": "linkedin",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "LinkedIn’s official updated tag template allows for both page-level and event-level tracking via easily configurable options.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "partnerId",
    "displayName": "Partner ID / Insight Tag ID",
    "simpleValueType": true,
    "notSetText": "Enter one or more Partner IDs separated by comma",
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "^\\d+(,\\s?\\d+)*$"
        ]
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "conversionId",
    "displayName": "Conversion IDs (max. 3)",
    "simpleValueType": true,
    "help": "Enter 1-3 conversion ids separated by comma. Only first 3 conversion ids will be sent. This field is optional",
    "canBeEmptyString": true,
    "valueValidators": [
      {
        "type": "REGEX",
        "args": [
          "^\\s*|\\d+(,\\s?\\d+)*$"
        ]
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "customUrl",
    "displayName": "Custom URL override",
    "simpleValueType": true,
    "help": "(Override) This is different than Match rules. Enter a URL only if you were specifically provided one by LinkedIn team to override.",
    "canBeEmptyString": true
  },
  {
    "type": "TEXT",
    "name": "eventId",
    "displayName": "Event ID",
    "simpleValueType": true,
    "help": "Enter an event id to deduplicate insight tag conversions with Conversions API conversions. The Conversions API conversion to be deduplicated must have the same event id. This field is optional",
    "canBeEmptyString": true
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const getUrl = require('getUrl');
const sendPixel = require('sendPixel');
const setInWindow = require('setInWindow');
const getTimestamp = require('getTimestamp');
const injectScript = require('injectScript');
const copyFromWindow = require('copyFromWindow');
const encodeUriComponent = require('encodeUriComponent');

/**
 * Globals
 */
const conversionIds = data.conversionId ?
      data.conversionId.split(',').slice(0,3).map(id => id.trim())
      : '';
const allPids = [];
const pageUrl = data.customUrl ? data.customUrl : getUrl();
const eventId = data.eventId;

let isScriptInjected = false;

/**
 * Checks presence of LinkedIn Insight tag code.
 */
const isInsightTagAPIAvailable = () => typeof copyFromWindow('lintrk') === 'function';

/**
 * Reads and Sets in global namespace all applicable PIDs on the page
 */
const setAllPids = (function() {
  const partnerIds = {};
  const bizoId = copyFromWindow('_bizo_data_partner_id');
  const bizoIds = copyFromWindow('_bizo_data_partner_ids') || [];
  const linkedInPartnerId = copyFromWindow('_linkedin_data_partner_id');
  const linkedInPartnerIds = copyFromWindow('_linkedin_data_partner_ids') || [];

  const addPid = pid => {
    if (pid && !partnerIds[pid]) {
      partnerIds[pid] = true;
      allPids.push(pid);
    }
  };

  // add the partner ids set via this GTM installation
  const inputPids = data.partnerId.split(',');
  inputPids.forEach(id => addPid(id.trim()));

  // Add all PIDs that may have updated the global, helps skipping following adds.
  addPid(linkedInPartnerId);
  linkedInPartnerIds.forEach(id => addPid(id));

  // add other PIDs from page
  addPid(bizoId);
  bizoIds.forEach(id => addPid(id));

  // Update the main namespace for future tracking by InsightTag to include the partner IDs
  setInWindow('_linkedin_data_partner_ids', allPids, true);
}());

/**
 * Generate query params only for GTM based tracking
 */
function generateQueryParamsForGTM(cid) {
  const encodedPIDs = encodeUriComponent(allPids.join(','));

  let result = 'pid=' + encodedPIDs;
  result += '&tm=gtmv2';
  result += cid ? '&conversionId=' + encodeUriComponent(cid) : '';
  result += '&url=' + encodeUriComponent(pageUrl);
  result += eventId ? '&eventId=' + encodeUriComponent(eventId) : '';
  result += '&v=2&fmt=js&time=' + getTimestamp();
  return result;
}

// Success call back to InsightTag injection
function didInjectInsightTag() {
  trackByInsightTag();
}

// Callback to plain GTM when InsightTag code failed to inject
function didFailInsightTag() {
  trackByPlainGTM();
}

function trackByPlainGTM() {
  if (conversionIds.length && conversionIds.length <= 3) {
    conversionIds.forEach(id => {
      const trackingUrl = 'https://px.ads.linkedin.com/collect?' + generateQueryParamsForGTM(id);
      sendPixel(trackingUrl, data.gtmOnSuccess, data.gtmOnFailure);
    });
  } else {
    sendPixel('https://px.ads.linkedin.com/collect?' + generateQueryParamsForGTM(), data.gtmOnSuccess, data.gtmOnFailure);
  }
}

/**
 * Download LinkedIn Insight tag core code if `window.lintrk` is not available
 * Also ensure it doesn’t default fire.
 */
function trackByInsightTag() {
  if (isInsightTagAPIAvailable()) {
    const lintrk = copyFromWindow('lintrk');
    const options = { tmsource: 'gtmv2' };
    options.conversion_url = pageUrl;

    if (eventId) {
      options.event_id = eventId;
    }

    if (conversionIds.length && conversionIds.length <= 3) {
      conversionIds.forEach(id => {
        options.conversion_id = id;
        lintrk('track', options);
      });
    } else {
      lintrk('track', options);
    }
    data.gtmOnSuccess();
  } else if (!isScriptInjected) {
    isScriptInjected = true;
    setInWindow('_already_called_lintrk', true, true);
    injectScript('https://snap.licdn.com/li.lms-analytics/insight.min.js', didInjectInsightTag, didFailInsightTag);
  } else {
    didInjectInsightTag();
  }
}

trackByInsightTag();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.linkedin.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_bizo_data_partner_id"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_bizo_data_partner_ids"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_linkedin_data_partner_id"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_linkedin_data_partner_ids"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "lintrk"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_already_called_lintrk"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://snap.licdn.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: No API - Test sendPixel with custom URL and single conversionId
  code: |-
    const mockData = {
      partnerId: '123',
      customUrl: 'google.com',
      conversionId: '12576358'
    };

    mock('injectScript', function(url, onSuccess, onFailure) {
      onFailure();
    });

    mock('sendPixel', (url, onSuccess, onFailure) => {
      assertThat(url).contains('https://px.ads.linkedin.com/collect?pid=123&tm=gtmv2&conversionId=12576358&url=google.com&v=2&fmt=js&time=');
      onSuccess();
    });

    runCode(mockData);
    assertApi('gtmOnSuccess').wasCalled();
- name: No API - Test sendPixel with page URL and no conversionId
  code: |-
    const encodeUriComponent = require('encodeUriComponent');
    const getUrl = require('getUrl');
    const mockData = { partnerId: '123' };

    mock('injectScript', function(url, onSuccess, onFailure) {
      onFailure();
    });

    mock('sendPixel', (url, onSuccess, onFailure) => {
      assertThat(url).contains('https://px.ads.linkedin.com/collect?pid=123&tm=gtmv2&url=' + encodeUriComponent(getUrl()) + '&v=2&fmt=js&time=');
      onSuccess();
    });

    runCode(mockData);
    assertApi('gtmOnSuccess').wasCalled();
- name: No API - Test sendPixel with eventId
  code: |-
    const encodeUriComponent = require('encodeUriComponent');
        const getUrl = require('getUrl');
        const mockData = {
          partnerId: '123',
          conversionId: '12576358',
          eventId: 'uniqueEventId123'
        };

    mock('injectScript', function(url, onSuccess, onFailure) {
      onFailure();
    });

    mock('sendPixel', (url, onSuccess, onFailure) => {
          assertThat(url).contains('https://px.ads.linkedin.com/collect?pid=123&tm=gtmv2&conversionId=12576358&url=' + encodeUriComponent(getUrl()) + '&eventId=uniqueEventId123&v=2&fmt=js&time=');
          onSuccess();
        });

        runCode(mockData);
        assertApi('gtmOnSuccess').wasCalled();
- name: With API - test script injection
  code: |-
    const getUrl = require('getUrl');
    const mockData = { partnerId: '123' };
    const copyFromWindow = require('copyFromWindow');

    mock('injectScript', (url) => {
      assertThat(url, 'correct script download URL is called').isEqualTo('https://snap.licdn.com/li.lms-analytics/insight.min.js');
    });

    runCode(mockData);
- name: No API - Multiple partnerIds and conversion ids
  code: "const mockData = {\n  partnerId: '123,456, 789, 299',\n  customUrl: 'google.com',\n\
    \  conversionId: '1, 2, 3, 4, 5'\n};\nconst callStack = [];\n\nmock('injectScript',\
    \ function(url, onSuccess, onFailure) {\n  onFailure();\n});\n\nmock('sendPixel',\
    \ (url, onSuccess, onFailure) => {\n  callStack.push(url);\n  \n  // Call success\
    \ only once when stack is full\n  if (callStack.length === 3) {\n    onSuccess();\n\
    \  }\n});\n\nrunCode(mockData);\n\nassertThat(callStack.length).isEqualTo(3);\n\
    \nassertThat(callStack[0]).contains('https://px.ads.linkedin.com/collect?pid=123%2C456%2C789%2C299&tm=gtmv2&conversionId=1&url=google.com&v=2&fmt=js&time=');\n\
    \nassertThat(callStack[1]).contains('https://px.ads.linkedin.com/collect?pid=123%2C456%2C789%2C299&tm=gtmv2&conversionId=2&url=google.com&v=2&fmt=js&time=');\n\
    \nassertThat(callStack[2]).contains('https://px.ads.linkedin.com/collect?pid=123%2C456%2C789%2C299&tm=gtmv2&conversionId=3&url=google.com&v=2&fmt=js&time=');\n\
    \nassertApi('gtmOnSuccess').wasCalled();"
- name: No API - Test script injection
  code: |-
    const mockData = { partnerId: '123' };

    let checkCount = 0;
    mock('copyFromWindow', (field) => {
      if (field === 'lintrk') {
        if (checkCount++ < 2) {
          return undefined;
        } else {
          return () => {};
        }
      }
    });

    mock('injectScript', function(url, onSuccess, onFailure) {
      assertThat(url).isEqualTo('https://snap.licdn.com/li.lms-analytics/insight.min.js');
      onSuccess();
    });


    runCode(mockData);

    assertApi('injectScript').wasCalled(1);
    assertApi('gtmOnSuccess').wasCalled();


___NOTES___

Created on 11/17/2021, 11:34:21 AM


